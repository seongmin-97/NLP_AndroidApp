# chapter 1 - 02 안드로이드 아키텍쳐

앞서 안드로이드와 코틀린에 대해 어렴풋이 알아봤다. 이번에 공부할 핵심 키워드는 컴파일, 빌드, 런타임, APK이다.

저번에 안드로이드 플랫폼에 대해 이야기했는데, 아키텍처는 이 플랫폼의 실제적인 동작 구조 또는 형태를 말한다. 우리가 작성한 소스 코드가 디바이스에 설치되면 이 아키텍처 구조 안에서 모든 동작이 결정된다.

코드는 어떻게 앱으로 만들어지고 스마트폰에서 실행될까? 지금부터 작성한 소스 코드의 설치 파일 생성 과정과 스마트폰에서 실행되기까지의 전 과정에 대해 알아보자.

우리가 다루는 안드로이드 플랫폼은 단순히 안드로이드 운영체제와 앱이 동작하는 소프트웨어까지만 포함한다. 하지만 더 넓게 보자면 앞으로 배울 안드로이드 스투디오와 앱이 거래되는 플레이 스토어, 앱이 동작하는 안드로이드 스마트폰까지가 하나의 거대한 안드로이드 플랫폼이다.

1. 소스 코드 작성에서 실행까지

    소스 코드 작성에서 실행까지는 아주 간단하다.

    a. 소스 코드 작성 : 코틀린으로 소스 코드를 작성한다.

    b. 설치 파일 생성 : 명령을 통해 안드로이드에서 실행될 수 있는 설치 파일의 형태로 변환한다.

    c. 업로드 : 구글 플레이 스토어에 앱을 업로드한다.

    d. 앱 등록 : 구글 플레이 스토어에 앱을 등록한다.

    e. 앱 선택/설치 : 스마트폰으로 구글 플레이 스토어에 접속한 다음 설치할 앱을 선택/설치한다.

    f. 스마트폰에서 실행 : 아이콘을 터치해서 앱을 실행한다.

2. 코드가 스마트폰에서 실행되는 과정

앞서 간단하게 설명했든 소스 코드 작성에서 실행까지의 단계가 실제 내부에서는 어떻게 진행되는지 살펴보자.

1) 빌드(컴파일 + 비밀번호) : b. 설치 파일 생성 단계는 빌드를 통해 진행된다. 이 과정에서 먼저 소스코드를 바이트 코드로 변환하며 APK 매니저에서 비밀번호를 가지고 있는 키 스토어와 조합해서 최종 설치 파일을 생성한다.

2) 파일 검증 : c. 업로드 단계로 단순히 파일을 업로드하는 데서 끝나는 게 아니라 구글 플레이 스토어에서 앱을 검수하는 과정을 거친다. 이 때 설치 파일이 정상적으로 동작하는지, 보안상의 문제는 없는지 등을 검사한다.

3) 플랫폼 버전 체크 : e. 앱 선택의 단계다. 스마트폰으로 구글 플레이 스토어에 접속하면 스마트폰의 플랫폼 버전을 확인한 다음 설치 가능한 앱의 목록만 보여준다.

4) AOT 컴파일/설치 권한 체크 : e. 앱 설치의 단계다. APK 파일을 설치하면 리눅스에서 실행 가능한 파일로 안드로이드 폰 내부에서 한 번 더 컴파일한다. 이 과정을 통해 실행 속도가 빨라지게 되며 사용자에게 기능의 사용 권한을 요청한다.

5) JIT 컴파일/실행 권한 체크 : f. 스마트폰에서 실행 단계이다. 4)에서 설치할 때는 필요한 파일만 컴파일한다. 그리고 첫 번째 앱을 실행할 때 미리 컴파일되지 않은 파일을 호출하면서 리눅스 실행 파일로 컴파일한다. 그리고 권한 중에 '실행 시 권한'이 포함되어 있으면 해당 코드가 동작해서 사용자에게 확인 요청을 한다.

3. 빌드

소스 코드를 변환해서 안드로이드에서의 실행 파일인 APK 파일로 만드는 것을 빌드(Bulid)라고 한다. 빌드는 소스 코드를 기계어로 변환한 후 라이브러리와 연결해서 실제 실행 파일로 만드는 과정을 일컫는 용어다. 안드로이드는 리눅스 커널 기반이므로 리눅스 시스템에서의 빌드를 이해하는 것이 도움이 된다.

- 컴파일

    컴파일(Compile)이란 사람이 읽을 수 있는 형태의 소스 코드를 컴퓨터가 읽을 수 있는 형태의 기계어로 변환해주는 과정이다. 컴퓨터는 기계어만 이해하고 동작하는데, 이 기계어의 구조를 사람이 이해하는 것이 어려워 C, 자바, 코틀린과 같은 컴퓨터 언어가 생긴 것이다.

- 리눅스에서의 빌드

    리눅스에서 빌드란 소스 코드를 컴퓨터가 읽을 수 있는 기계로 번역(컴파일)하고, 내가 만든 소스 코드에서 사용하는 라이브러리와 연결(Link)해서 최종 실행 파일 형태로 만드는 것이다.

- 안드로이드에서의 빌드

    안드로이드에서의 빌드를 이해하기 위해서는 먼저 컴파일 과정부터 다시 살펴보는 것이 좋다. 리눅스 컴파일과 다른 점은 안드로이드에는 리소스(Resource)라는 개념이 있다는 점이다. 안드로이드는 2단계로 컴파일을 나눌 수 있다. 

    먼저 1단계는 바이트코드 단계이다. 소스 코드와 리소스(이미지 파일, 음악 파일 등), 라이브러리까지 한 번에 컴파일 해준다 이 때 생성된 파일은 안드로이드 플랫폼에서 인식할 수 있는 바이트코드로 컴파일된다. 이 파일은 스마트폰에서 바로 실행할 수 없다.

    2단계는 APK 파일 생성 단계다. 안드로이드의 빌드는 1단계에서 생성된 파일을 APK 매니저라는 도구로 개발자가 설정한 패스워드와 조합해서 설치 파일은 APK 파일로 만들어 준다. 

    이렇게 두 단계를 모두 거쳐 APK 파일이 생성된 과정을 빌드라고 한다.

4. 설치와 실행

안드로이드의 아키텍처는 앱 설치부터 실행 후 종료할 때까지 계속 따라다니면서 관여한다. 앞서      안드로이드 플랫폼을 설명하며 살펴봤던 그림이 실은 안드로이드의 아키텍처 구조이다. 우리가 설치하는 앱이 가장 상단에 있는 애플리케이션 영역에서 동작하고, 안드로이드는 중간에 있는 안드로이드 런타임 영역에서 개발자가 만든 앱을 제어한다.

앱을 설치하면 설치 파일의 일부(APK)가 리눅스 운영체제에서 실행할 수 있는 파일 형태로 한 번 더 컴파일되는데 이런 구조를 AOT(Ahead of Time)라고 한다. 플랫폼 버전 5.0 롤리팝에서는 이와 같이 모든 파일이 설치할 때 컴파일되는 형태였다가 효율성의 문제로 일부만 컴파일되는 형태로 변경되었다.

앱을 실행하면 호출되는 파일 중에서 컴파일되지 않았던 파일이 한 번 더 컴파일되는데, 이 구조를 JIT(Just-in-Time)d라고 한다.

안드로이드는 이렇게 2개의 컴파일 형태를 같이 사용함으로써 효율성을 높이고 있다.